package com.hycujjang.controller.lectureboard.evaluation;

import java.io.IOException;
import java.io.PrintWriter;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import com.hycujjang.objectPack.evaluation.EvaluationDAO;
import com.hycujjang.objectPack.evaluation.EvaluationDTO;

@WebServlet("/evaluationRegisterController")
public class EvaluationRegisterController extends HttpServlet{
	@Override
	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		String userID = null;
		String lectureName = null;
		String professorName = null;
		String lectureYear = null;
		String semesterDivide = null;
	    String lectureDivide = null;
		String evaluationTitle = null;
		String evaluationContent = null;
		String totalScore = null;
		String creditScore = null;
		String comfortableScore = null;
		String lectureScore = null;
		String resultCode = null;
		String evaluationID = null;
		
		if (request.getSession().getAttribute("userID") != null) {
			userID = (String) request.getSession().getAttribute("userID");
		}
		
		if (request.getParameter("lectureName") != null) {
			lectureName = request.getParameter("lectureName");
		}
		
		if (request.getParameter("professorName") != null) {
			professorName = request.getParameter("professorName");
		}
		
		if (request.getParameter("lectureYear") != null) {
			lectureYear = request.getParameter("lectureYear");
		}
		
		if (request.getParameter("semesterDivide") != null) {
			semesterDivide = request.getParameter("semesterDivide");
		}
		
		if (request.getParameter("lectureDivide") != null) {
			lectureDivide = request.getParameter("lectureDivide");
		}
		
		if (request.getParameter("evaluationTitle") != null) {
			evaluationTitle = request.getParameter("evaluationTitle");
		}
		
		if (request.getParameter("evaluationContent") != null) {
			evaluationContent = request.getParameter("evaluationContent");
		}
		
		if (request.getParameter("totalScore") != null) {
			totalScore = request.getParameter("totalScore");
		}
		
		if (request.getParameter("creditScore") != null) {
			creditScore = request.getParameter("creditScore");
		}
		
		if (request.getParameter("comfortableScore") != null) {
			comfortableScore = request.getParameter("comfortableScore");
		}
		
		if (request.getParameter("lectureScore") != null) {
			lectureScore = request.getParameter("lectureScore");
		}
		
		if (request.getParameter("evaluationID") != null) {
			evaluationID = request.getParameter("evaluationID");
		}
		
		if (isWhiteSpace(lectureName) || isWhiteSpace(professorName) || isWhiteSpace(lectureYear)
				|| isWhiteSpace(semesterDivide) || isWhiteSpace(lectureDivide) || isWhiteSpace(evaluationTitle) 
				|| isWhiteSpace(evaluationContent) || isWhiteSpace(totalScore) ||  isWhiteSpace(creditScore)
				|| isWhiteSpace(comfortableScore) || isWhiteSpace(lectureScore)) {
			resultCode = parseJson("null");
			response.getWriter().write(resultCode);
			return;
		}
		
		int year = Integer.parseInt(lectureYear);
		EvaluationDAO evaluationDAO = new EvaluationDAO();
		EvaluationDTO evaluationDTO = new EvaluationDTO(0, userID, lectureName, professorName, year, 
				semesterDivide, lectureDivide, evaluationTitle, evaluationContent, 
				totalScore, creditScore, comfortableScore, lectureScore, 0);
		int result = 0;
		if (evaluationID == null) {
			evaluationDAO.write(evaluationDTO);
		} else {
			evaluationDAO.update(evaluationDTO);
		}
		
		if (result == -1) {
			//pageBack(response, "강의평가 등록에 실패 했습니다.");
			resultCode = parseJson("error");
		} else {
			//pageBack(response, "정상적으로 등록 되었습니다.");
			resultCode = parseJson("ok");
		}
		
		response.getWriter().write(resultCode);
	}
	
	private String parseJson(String resultCode) {		
		StringBuilder sb = new StringBuilder();
		sb.append("[{\"resultCode\":\"");
		sb.append(resultCode);
		sb.append("\"}]");
		
		return sb.toString();
	}
	
	private boolean isWhiteSpace(String str) {
		if (str == null || str.equals("")) {
			return true;
		}
		return false;
	}
	
	private void pageBack(HttpServletResponse response, String alertMsg) throws IOException {
		PrintWriter script = response.getWriter();
		script.println("<script>");
		script.println("alert('" + alertMsg + "');");
		script.println("location.href = 'index.jsp'");
		script.println("</script>");
		script.close();
	}
}
